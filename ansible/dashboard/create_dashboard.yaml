#!/usr/bin/env -S ansible-playbook -K
# NOTE: Don't provide the playbook filename in the shebang. It is added automatically.
---

- name: Configure Kubernetes Dashboard Playbook
  hosts: master
  remote_user: kube_user
  become: yes
  become_user: root
  gather_facts: true

  tasks:
    - name: Ensure 'kube_user' exists
      user:
        name: kube_user
        state: present

    - name: Allow 'kube_user' to use sudo without a password
      lineinfile:
        dest: /etc/sudoers
        line: 'kube_user ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'

    - name: Update apt package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - python3-pip
          - iptables-persistent
        state: present
        update_cache: yes

    - name: Add Docker's official GPG key and repository
      block:
        - name: Add Docker's GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
            state: present

    - name: Install Docker and Docker Compose plugin
      apt:
        name:
          - docker-ce
          - docker-compose-plugin
        state: present

    - name: Ensure Docker service is running and enabled
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create docker group if it does not exist
      group:
        name: docker
        state: present

    - name: Add 'kube_user' to the docker group
      user:
        name: kube_user
        groups: docker
        append: yes

    - name: Copy dashboard directory to /home/kube_user
      synchronize:
        src: ../../k8-dashboard/
        dest: /home/kube_user/k8-dashboard
        mode: push
        recursive: yes
        owner: yes
        group: yes
        perms: yes

    - name: Run docker-compose up
      shell: |
        docker compose up -d
      args:
        chdir: /home/kube_user/k8-dashboard
      become: yes
      become_user: kube_user

    - name: Verify docker-compose services are running
      shell: |
        docker compose ps
      args:
        chdir: /home/kube_user/k8-dashboard
      register: docker_compose_status
      become: yes
      become_user: kube_user

    - name: Verify if the service kubernetes-dashboard is running
      ansible.builtin.assert:
        that:
          - "'Up' in docker_compose_status.stdout"
          - "'kubernetes-dashboard' in docker_compose_status.stdout"
        fail_msg: "The kubernetes-dashboard service is not running!"
        success_msg: "The kubernetes-dashboard service is up and running!"
    
    - name: Generate token for admin-user
      command: kubectl -n kube-system create token admin-user
      register: token_output
      become: yes
      become_user: kube_user

    - name: Display generated token
      debug:
        msg: "Generated Token: {{ token_output.stdout }}"

    
